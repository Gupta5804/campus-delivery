pipeline {
    agent any
    stages{
        stage("Verifying tooling"){
            steps{
                sh '''
                    whoami
                    docker version
                    docker info
                    docker-compose version
                    curl --version
                    jq --version

                '''
            }
        }
        // stage('Prune Docker data'){
        //    steps{
        //         sh 'docker system prune -a --volumes -f'
        //     }
        // }
        //stage("Restore npm packages") {
        //    steps {
        //        // Writes lock-file to cache based on the GIT_COMMIT hash
        //        writeFile file: "next-lock.cache", text: "$GIT_COMMIT"
//
        //        cache(caches: [
        //            arbitraryFileCache(
        //                path: "node_modules",
        //                includes: "**/*",
        //                cacheValidityDecidingFile: "package-lock.json"
        //            )
        //        ]) {
        //            sh "npm install"
        //        }
        //    }
        //}
        //stage("Build") {
        //    steps {
        //        // Writes lock-file to cache based on the GIT_COMMIT hash
        //        writeFile file: "next-lock.cache", text: "$GIT_COMMIT"
        //
        //        cache(caches: [
        //            arbitraryFileCache(
        //                path: ".next/cache",
        //                includes: "**/*",
        //                cacheValidityDecidingFile: "next-lock.cache"
        //            )
        //        ]) {
        //            // aka `next build`
        //            sh "npm run build"
        //        }
        //    }
        //}
        stage('Start container'){
            steps{
                
                script{
                   withEnv(["ALLOWED_HOSTS = ${env.ALLOWED_HOSTS}","DATABASE_URL = ${env.DATABASE_URL}","DEBUG = ${env.DEBUG}","SECRET_KEY = ${env.SECRET_KEY}"]){

                    echo '[ALLOWED_HOSTS = ${env.ALLOWED_HOSTS},DATABASE_URL = ${env.DATABASE_URL},DEBUG = ${env.DEBUG},SECRET_KEY = ${env.SECRET_KEY}]'
                    
                    sh 'docker-compose -f docker-compose.prod.yml up -d --build'
                    sh 'docker-compose -f docker-compose.prod.yml ps'
                    

                   } 
                }
                //sh 'docker-compose -f docker-compose.prod.yml up -d --build'
                //sh 'docker-compose -f docker-compose.prod.yml ps'
            }
        }
        stage('Running tests against the container'){
            steps{
                sh 'curl http://localhost:80'
            }
        }

    }
    //post {
    //    always {
    //        sh 'docker-compose down --remove-orphans -v'
    //        sh 'docker-compose ps'
    //    }
    //}
}
